name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install ZSH
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh
          
      - name: Validate ZSH Configuration
        run: |
          echo "üß™ Validating ZSH configuration syntax..."
          zsh -n zshrc || {
            echo "‚ùå ZSH configuration syntax error"
            exit 1
          }
          echo "‚úÖ ZSH configuration syntax valid"
          
      - name: Check required files
        run: |
          echo "üîç Checking required files..."
          
          required_files=(
            "install.zsh"
            "uninstall.zsh" 
            "update.zsh"
            "test_config.zsh"
            "quick_test.zsh"
            "manage_secrets.zsh"
            "zshrc"
            "zprofile"
            "README.md"
            "CHANGELOG.md"
            "VERSION.md"
            "LICENSE"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "‚ùå Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required files present"
          
      - name: Validate directory structure
        run: |
          echo "üèóÔ∏è Validating directory structure..."
          
          required_dirs=("aliases" "functions" "plugins" "themes" "secrets")
          missing_dirs=()
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              missing_dirs+=("$dir")
            fi
          done
          
          if [ ${#missing_dirs[@]} -ne 0 ]; then
            echo "‚ùå Missing required directories:"
            printf '  - %s\n' "${missing_dirs[@]}"
            exit 1
          fi
          
          echo "‚úÖ Directory structure valid"
          
      - name: Validate script permissions
        run: |
          echo "üîí Validating script permissions..."
          
          scripts=("install.zsh" "uninstall.zsh" "update.zsh" "test_config.zsh" "quick_test.zsh" "manage_secrets.zsh")
          
          for script in "${scripts[@]}"; do
            if [ ! -x "$script" ]; then
              echo "‚ùå Script not executable: $script"
              exit 1
            fi
          done
          
          echo "‚úÖ All scripts are executable"
          
      - name: Check for secrets or sensitive data
        run: |
          echo "üîê Scanning for secrets or sensitive data..."
          
          # Check for actual secret values (not just references)
          found_secrets=false
          
          # Check for SSH private keys
          if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential private keys"
            found_secrets=true
          fi
          
          # Check for base64 encoded secrets (long strings that look like tokens)
          if grep -rE '[A-Za-z0-9+/]{40,}={0,2}' . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" --exclude-dir=secrets 2>/dev/null | grep -v "example\|test\|demo"; then
            echo "‚ö†Ô∏è Found potential base64 encoded secrets"
            found_secrets=true
          fi
          
          # Check for AWS/API key patterns
          if grep -rE '(AKIA[0-9A-Z]{16}|[0-9a-zA-Z]{40})' . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" --exclude-dir=secrets 2>/dev/null | grep -v "example\|test\|demo"; then
            echo "‚ö†Ô∏è Found potential AWS or API keys"
            found_secrets=true
          fi
          
          if [ "$found_secrets" = true ]; then
            echo "‚ùå Potential secrets detected. Please review and ensure no actual secrets are committed."
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets detected"
          
      - name: Validate changelog format
        run: |
          echo "üìù Validating changelog format..."
          
          if [ ! -f CHANGELOG.md ]; then
            echo "‚ùå CHANGELOG.md not found"
            exit 1
          fi
          
          # Check for required sections
          if ! grep -q "# Changelog" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing main header"
            exit 1
          fi
          
          if ! grep -q "\[Keep a Changelog\]" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing Keep a Changelog reference"
            exit 1
          fi
          
          if ! grep -q "\[Semantic Versioning\]" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing Semantic Versioning reference"
            exit 1
          fi
          
          echo "‚úÖ CHANGELOG.md format valid"
          
      - name: Validate version format
        run: |
          echo "üè∑Ô∏è Validating version format..."
          
          if [ ! -f VERSION.md ]; then
            echo "‚ùå VERSION.md not found"
            exit 1
          fi
          
          # Check for version header
          if ! grep -q "# Version History" VERSION.md; then
            echo "‚ùå VERSION.md missing version history header"
            exit 1
          fi
          
          # Check for at least one version entry
          if ! grep -q "## v[0-9]" VERSION.md; then
            echo "‚ùå VERSION.md missing version entries"
            exit 1
          fi
          
          echo "‚úÖ VERSION.md format valid"

  test-installation:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          # Install ZSH
          sudo apt-get update
          sudo apt-get install -y zsh curl git
          
          # Make ZSH available to user
          sudo chsh -s $(which zsh) $USER
          
      - name: Test dry-run installation
        run: |
          echo "üß™ Testing installation process (dry-run)..."
          
          # Make sure install script is executable
          chmod +x install.zsh
          
          # Simulate installation (would need modification to install.zsh for full CI testing)
          echo "Installation script validated"
          
      - name: Test configuration loading
        run: |
          echo "üîÑ Testing configuration loading..."
          
          # Source the configuration in a subshell to test for errors
          zsh -c "source ./zshrc" || {
            echo "‚ùå Configuration loading failed"
            exit 1
          }
          
          echo "‚úÖ Configuration loads without errors"

  security-scan:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Run security scan
        run: |
          echo "üîí Running security scan..."
          
          # Check file permissions
          find . -type f -perm /002 | grep -v ".git" && {
            echo "‚ùå World-writable files found"
            exit 1
          } || echo "‚úÖ No world-writable files"
          
          # Check for shell injection vulnerabilities
          grep -r "eval.*\$" . --exclude-dir=.git && {
            echo "‚ö†Ô∏è Potential shell injection found with eval"
          } || echo "‚úÖ No obvious shell injection patterns"
          
          # Check for hardcoded paths that might be user-specific
          grep -r "/Users/[^/]*/" . --exclude-dir=.git --exclude="*.md" && {
            echo "‚ö†Ô∏è Hardcoded user paths found"
          } || echo "‚úÖ No hardcoded user paths"
          
          echo "üîí Security scan completed"