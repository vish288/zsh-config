name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install ZSH and shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh shellcheck
          
      - name: Validate ZSH Configuration
        run: |
          echo "üß™ Validating ZSH configuration syntax..."
          zsh -n zshrc || {
            echo "‚ùå ZSH configuration syntax error"
            exit 1
          }
          echo "‚úÖ ZSH configuration syntax valid"

      - name: Shellcheck lint
        run: |
          echo "üîç Running shellcheck on shell scripts..."
          shellcheck_errors=0

          # Check executable scripts (shell agnostic checks)
          for script in install.zsh uninstall.zsh update.zsh test_config.zsh quick_test.zsh manage_secrets.zsh release.zsh; do
            if [ -f "$script" ]; then
              echo "  Checking $script..."
              # SC1071: ShellCheck only supports sh/bash/dash/ksh - skip zsh-specific syntax errors
              # SC2039: allow zsh/bash-specific syntax
              # SC2086: double quote warning (zsh handles this differently)
              shellcheck -s bash -e SC1071,SC2039,SC2086,SC1090,SC1091,SC2034,SC2148,SC2155,SC2162,SC2059 "$script" || shellcheck_errors=$((shellcheck_errors + 1))
            fi
          done

          if [ $shellcheck_errors -gt 0 ]; then
            echo "‚ö†Ô∏è ShellCheck found issues in $shellcheck_errors file(s), please review"
          else
            echo "‚úÖ ShellCheck passed"
          fi

      - name: Check required files
        run: |
          echo "üîç Checking required files..."
          
          required_files=(
            "install.zsh"
            "uninstall.zsh"
            "update.zsh"
            "test_config.zsh"
            "quick_test.zsh"
            "manage_secrets.zsh"
            "zshrc"
            "zprofile"
            "README.md"
            "docs/CHANGELOG.md"
            "LICENSE"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "‚ùå Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required files present"
          
      - name: Validate directory structure
        run: |
          echo "üèóÔ∏è Validating directory structure..."

          # Core directories (secrets is gitignored)
          required_dirs=("aliases" "functions" "plugins" "themes" "docs")
          missing_dirs=()

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              missing_dirs+=("$dir")
            fi
          done

          if [ ${#missing_dirs[@]} -ne 0 ]; then
            echo "‚ùå Missing required directories:"
            printf '  - %s\n' "${missing_dirs[@]}"
            exit 1
          fi

          echo "‚úÖ Directory structure valid"
          
      - name: Validate script permissions
        run: |
          echo "üîí Validating script permissions..."
          
          scripts=("install.zsh" "uninstall.zsh" "update.zsh" "test_config.zsh" "quick_test.zsh" "manage_secrets.zsh")
          
          for script in "${scripts[@]}"; do
            if [ ! -x "$script" ]; then
              echo "‚ùå Script not executable: $script"
              exit 1
            fi
          done
          
          echo "‚úÖ All scripts are executable"
          
      - name: Check for secrets or sensitive data
        run: |
          echo "üîê Scanning for secrets or sensitive data..."
          
          # Check for actual secret values (not just references)
          found_secrets=false
          
          # Check for SSH private keys
          if grep -r "BEGIN.*PRIVATE KEY" . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" 2>/dev/null; then
            echo "‚ö†Ô∏è Found potential private keys"
            found_secrets=true
          fi
          
          # Check for base64 encoded secrets (excluding URLs and common patterns)
          if grep -rE '[A-Za-z0-9+/]{60,}={0,2}' . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" --exclude-dir=secrets 2>/dev/null | grep -v "example\|test\|demo\|github\.com\|githubusercontent\.com\|https://"; then
            echo "‚ö†Ô∏è Found potential base64 encoded secrets"
            found_secrets=true
          fi
          
          # Check for AWS access keys specifically (more precise pattern)
          if grep -rE 'AKIA[0-9A-Z]{16}' . --exclude-dir=.git --exclude-dir=.github --exclude="*.md" --exclude-dir=secrets 2>/dev/null | grep -v "example\|test\|demo"; then
            echo "‚ö†Ô∏è Found potential AWS access keys"
            found_secrets=true
          fi
          
          if [ "$found_secrets" = true ]; then
            echo "‚ùå Potential secrets detected. Please review and ensure no actual secrets are committed."
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets detected"
          
      - name: Validate changelog format
        run: |
          echo "üìù Validating changelog format..."

          if [ ! -f docs/CHANGELOG.md ]; then
            echo "‚ùå docs/CHANGELOG.md not found"
            exit 1
          fi

          # Check for required sections
          if ! grep -q "# Changelog" docs/CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing main header"
            exit 1
          fi

          if ! grep -q "\[Keep a Changelog\]" docs/CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing Keep a Changelog reference"
            exit 1
          fi

          if ! grep -q "\[Semantic Versioning\]" docs/CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md missing Semantic Versioning reference"
            exit 1
          fi

          echo "‚úÖ CHANGELOG.md format valid"

  test-installation:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          # Install ZSH
          sudo apt-get update
          sudo apt-get install -y zsh curl git
          
          # Make ZSH available to user
          sudo chsh -s $(which zsh) $USER
          
      - name: Test dry-run installation
        run: |
          echo "üß™ Testing installation process (dry-run)..."
          
          # Make sure install script is executable
          chmod +x install.zsh
          
          # Simulate installation (would need modification to install.zsh for full CI testing)
          echo "Installation script validated"
          
      - name: Test configuration loading
        run: |
          echo "üîÑ Testing configuration loading..."
          
          # Create minimal directory structure for testing
          mkdir -p plugins aliases functions secrets themes
          
          # Create stub files to prevent sourcing errors
          touch plugins/powerlevel10k.zsh
          touch plugins/oh-my-zsh.zsh  
          touch plugins/completions.zsh
          touch aliases/core.zsh
          touch functions/core.zsh
          touch secrets/secrets.zsh
          
          # Test syntax validation instead of full sourcing
          zsh -n ./zshrc || {
            echo "‚ùå Configuration syntax invalid"
            exit 1
          }
          
          echo "‚úÖ Configuration syntax valid"

  security-scan:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Run security scan
        run: |
          echo "üîí Running security scan..."
          
          # Check file permissions
          find . -type f -perm /002 | grep -v ".git" && {
            echo "‚ùå World-writable files found"
            exit 1
          } || echo "‚úÖ No world-writable files"
          
          # Check for shell injection vulnerabilities
          grep -r "eval.*\$" . --exclude-dir=.git && {
            echo "‚ö†Ô∏è Potential shell injection found with eval"
          } || echo "‚úÖ No obvious shell injection patterns"
          
          # Check for hardcoded paths that might be user-specific
          grep -r "/Users/[^/]*/" . --exclude-dir=.git --exclude="*.md" && {
            echo "‚ö†Ô∏è Hardcoded user paths found"
          } || echo "‚úÖ No hardcoded user paths"
          
          echo "üîí Security scan completed"